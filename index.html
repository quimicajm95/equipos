<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Equipos - FarmaciaQuímica</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --dark-bg: #1a1a2e;
      --card-bg: #16213e;
      --text-light: #ecf0f1;
    }
    body {
      background: linear-gradient(135deg, var(--dark-bg) 0%, #0f3460 100%);
      color: var(--text-light);
      min-height: 100vh;
      padding: 40px 20px;
    }
    .card-box {
      max-width: 600px;
      margin: auto;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }
    .form-control, .form-select {
      background-color: #2c3e50;
      border: 1px solid #34495e;
      color: var(--text-light);
      font-size: 1.1rem;
    }
    .form-control:focus, .form-select:focus {
      background-color: #34495e;
      color: var(--text-light);
      border-color: var(--warning);
      box-shadow: 0 0 0 .2rem rgba(243, 156, 18,.25);
    }
    .btn-register {
      background: linear-gradient(135deg, var(--secondary), var(--warning));
      border: none;
      padding: 12px 30px;
      font-size: 1.2rem;
      border-radius: 50px;
      transition: .3s;
    }
    .btn-register:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(52, 152, 219,.4);
    }
    .btn-result {
      background: linear-gradient(135deg, var(--success), #229954);
      border: none;
      padding: 12px 30px;
      font-size: 1.2rem;
      border-radius: 50px;
      transition: .3s;
    }
    .btn-result:disabled {
      background: #7f8c8d;
      cursor: not-allowed;
    }
    .icon-pills {
      font-size: 3rem;
      color: var(--warning);
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="card-box text-center">
    <i class="fas fa-pills icon-pills"></i>
    <h2 class="mb-4">Registro de Equipos - Laboratorio</h2>

    <form id="formulario">
      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre completo (con apellidos)</label>
        <textarea class="form-control" id="nombre" name="nombre" rows="2" required placeholder="Ej. Ana García López"></textarea>
      </div>

      <div class="mb-4">
        <label for="equipo" class="form-label">Equipo</label>
        <select class="form-select" id="equipo" name="equipo" required>
          <!-- se llena dinámicamente -->
        </select>
      </div>

      <button type="submit" class="btn btn-primary btn-register">
        <i class="fas fa-save me-2"></i>Registrar
      </button>
    </form>

    <button id="btnResultados" class="btn btn-success btn-result mt-4" disabled onclick="location.href='resultados.html'">
      <i class="fas fa-chart-bar me-2"></i>Ver Resultados
    </button>

    <div id="msg" class="mt-3"></div>
  </div>

  <script>
    /* ---------- CONFIG ---------- */
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyXMFxSScjXfXNU7MnSuy3psCOKWyRh9UEZ2P7WmMDRabYA-jkqz665CGKDe'; // <--- cambia
    const MAX_POR_EQUIPO = 5;
    const EQUIPOS = 12;

    /* ---------- ELEMENTOS ---------- */
    const form = document.getElementById('formulario');
    const select = document.getElementById('equipo');
    const btn = document.getElementById('btnResultados');
    const msg = document.getElementById('msg');

    /* ---------- CARGAR EQUIPOS DISPONIBLES ---------- */
    async function cargarEquipos() {
      const raw = await fetch(SCRIPT_URL + '?action=listar');
      const txt = await raw.text();
      const rows = txt.trim().split('\n').slice(1); // sin cabecera
      const cuenta = {};
      for (let i = 1; i <= EQUIPOS; i++) cuenta[i] = 0;
      rows.forEach(r => {
        const [, eq] = r.split('\t');
        if (eq) cuenta[eq]++;
      });
      select.innerHTML = '';
      for (let i = 1; i <= EQUIPOS; i++) {
        if (cuenta[i] < MAX_POR_EQUIPO) {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = `Equipo ${i} (${cuenta[i]}/${MAX_POR_EQUIPO})`;
          select.appendChild(opt);
        }
      }
      const llenos = Object.values(cuenta).filter(c => c === MAX_POR_EQUIPO).length;
      btn.disabled = llenos < EQUIPOS;
      if (select.children.length === 0 && llenos === EQUIPOS) {
        btn.disabled = false;
        msg.textContent = 'Todos los equipos están llenos. Puedes ver resultados.';
      }
    }

    /* ---------- ENVIAR DATOS ---------- */
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const nombre = form.nombre.value.trim();
      const equipo = form.equipo.value;
      if (!nombre || !equipo) return;
      msg.textContent = 'Guardando...';
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({nombre, equipo})
      });
      const txt = await res.text();
      if (txt === 'ok') {
        msg.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> ¡Registrado!</span>';
        form.reset();
        cargarEquipos();
      } else {
        msg.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle"></i> Error al registrar.</span>';
      }
    });

    /* ---------- POLLING ---------- */
    cargarEquipos();
    setInterval(cargarEquipos, 3000);
  </script>
</body>
</html>
