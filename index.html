<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Equipos - Laboratorio de Quimica</title>
  <title>Facultadd de Farmacia - 1er año</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --dark-bg: #1a1a2e;
      --card-bg: #16213e;
      --text-light: #ecf0f1;
    }
    body {
      background: linear-gradient(135deg, var(--dark-bg) 0%, #0f3460 100%);
      color: var(--text-light);
      min-height: 100vh;
      padding: 40px 20px;
    }
    .card-box {
      max-width: 600px;
      margin: auto;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }
    .form-control, .form-select {
      background-color: #2c3e50;
      border: 1px solid #34495e;
      color: var(--text-light);
      font-size: 1.1rem;
    }
    .form-control:focus, .form-select:focus {
      background-color: #34495e;
      color: var(--text-light);
      border-color: var(--warning);
      box-shadow: 0 0 0 .2rem rgba(243, 156, 18,.25);
    }
    .btn-register {
      background: linear-gradient(135deg, var(--secondary), var(--warning));
      border: none;
      padding: 12px 30px;
      font-size: 1.2rem;
      border-radius: 50px;
      transition: .3s;
    }
    .btn-register:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(52, 152, 219,.4);
    }
    .btn-result {
      background: linear-gradient(135deg, var(--success), #229954);
      border: none;
      padding: 12px 30px;
      font-size: 1.2rem;
      border-radius: 50px;
      transition: .3s;
    }
    .btn-result:disabled {
      background: #7f8c8d;
      cursor: not-allowed;
    }
    .icon-pills {
      font-size: 3rem;
      color: var(--warning);
      margin-bottom: 15px;
    }
    .option-disabled {
      color: #e74c3c !important;
      font-style: italic;
      opacity: 0.7;
    }
    .option-available {
      color: #27ae60 !important;
    }
    .badge-counter {
      font-size: 0.8rem;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 5px;
    }
    .badge-full {
      background-color: #e74c3c;
    }
    .badge-available {
      background-color: #27ae60;
    }
  </style>
</head>
<body>
  <div class="card-box text-center">
    <i class="fas fa-pills icon-pills"></i>
    <h2 class="mb-4">Registro de Equipos - Laboratorio</h2>

    <form id="formulario">
      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre completo (con apellidos)</label>
        <textarea class="form-control" id="nombre" name="nombre" rows="2" required placeholder="Ej. Ana García López"></textarea>
      </div>

      <div class="mb-4">
        <label for="equipo" class="form-label">Equipo</label>
        <select class="form-select" id="equipo" name="equipo" required>
          <option value="" selected disabled>Seleccione un equipo</option>
          <!-- Se generan los equipos 1-12 dinámicamente -->
        </select>
        <div class="form-text text-warning mt-2">
          <i class="fas fa-info-circle me-1"></i> Cada equipo acepta máximo 5 personas. Los equipos llenos aparecen deshabilitados.
        </div>
      </div>

      <button type="submit" class="btn btn-primary btn-register">
        <i class="fas fa-save me-2"></i>Registrar
      </button>
    </form>

    <button id="btnResultados" class="btn btn-success btn-result mt-4" disabled onclick="location.href='resultados.html'">
      <i class="fas fa-chart-bar me-2"></i>Ver Resultados
    </button>

    <div id="msg" class="mt-3"></div>
    
    <!-- Panel de estado de equipos -->
    <div id="estadoEquipos" class="mt-4 p-3 rounded" style="background: rgba(255,255,255,0.1);">
      <h6 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Estado de Equipos</h6>
      <div class="row" id="contadorEquipos">
        <!-- Se llena dinámicamente -->
      </div>
    </div>
  </div>

  <script>
    /* ---------- CONFIG ---------- */
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyXMFxSScjXfXNU7MnSuy3psCOKWyRh9UEZ2P7WmMDRabYA-jkqz665CGKDe';
    const MAX_POR_EQUIPO = 5;
    const TOTAL_EQUIPOS = 12;

    /* ---------- ELEMENTOS ---------- */
    const form = document.getElementById('formulario');
    const select = document.getElementById('equipo');
    const btn = document.getElementById('btnResultados');
    const msg = document.getElementById('msg');
    const contadorEquipos = document.getElementById('contadorEquipos');

    /* ---------- CARGAR Y ACTUALIZAR EQUIPOS ---------- */
    async function cargarYActualizarEquipos() {
      try {
        // Obtener datos de Google Sheets
        const raw = await fetch(SCRIPT_URL + '?action=listar');
        const txt = await raw.text();
        const rows = txt.trim().split('\n').slice(1); // Saltar cabecera
        
        // Contar personas por equipo
        const cuenta = {};
        for (let i = 1; i <= TOTAL_EQUIPOS; i++) {
          cuenta[i] = 0;
        }
        
        rows.forEach(r => {
          const [, equipo] = r.split('\t');
          if (equipo && !isNaN(equipo)) {
            const numEquipo = parseInt(equipo);
            if (numEquipo >= 1 && numEquipo <= TOTAL_EQUIPOS) {
              cuenta[numEquipo]++;
            }
          }
        });

        // GUARDAR ESTADO ACTUAL PARA USAR EN EL FORMULARIO
        window.estadoEquipos = cuenta;

        // ACTUALIZAR SELECT CON TODOS LOS EQUIPOS 1-12
        actualizarSelectEquipos(cuenta);
        
        // ACTUALIZAR PANEL VISUAL DE ESTADO
        actualizarPanelEstado(cuenta);
        
        // VERIFICAR SI TODOS LOS EQUIPOS ESTÁN LLENOS
        const equiposLlenos = Object.values(cuenta).filter(c => c === MAX_POR_EQUIPO).length;
        btn.disabled = equiposLlenos < TOTAL_EQUIPOS;

        // MOSTRAR MENSAJES
        if (equiposLlenos === TOTAL_EQUIPOS) {
          msg.innerHTML = '<div class="alert alert-success mt-3"><i class="fas fa-flag-checkered me-2"></i><strong>¡Completado!</strong> Todos los equipos están llenos. Puedes ver los resultados.</div>';
          btn.disabled = false;
        } else if (equiposLlenos > 0) {
          const disponibles = TOTAL_EQUIPOS - equiposLlenos;
          msg.innerHTML = `<div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>${equiposLlenos} equipo(s) llenos</strong>, ${disponibles} equipo(s) con cupo disponible.
          </div>`;
        } else {
          msg.textContent = '';
        }

      } catch (error) {
        console.error('Error cargando equipos:', error);
        // Si hay error, al menos mostrar los equipos básicos
        const cuentaVacia = {};
        for (let i = 1; i <= TOTAL_EQUIPOS; i++) cuentaVacia[i] = 0;
        actualizarSelectEquipos(cuentaVacia);
        msg.innerHTML = '<div class="alert alert-warning mt-3"><i class="fas fa-exclamation-triangle me-2"></i>Error al conectar. Mostrando lista básica de equipos.</div>';
      }
    }

    /* ---------- ACTUALIZAR SELECT CON EQUIPOS 1-12 ---------- */
    function actualizarSelectEquipos(cuenta) {
      // Guardar selección actual si existe
      const seleccionActual = select.value;
      
      // Limpiar select (excepto primera opción placeholder)
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // Agregar TODOS los equipos del 1 al 12
      for (let i = 1; i <= TOTAL_EQUIPOS; i++) {
        const personasEnEquipo = cuenta[i] || 0;
        const estaLleno = personasEnEquipo >= MAX_POR_EQUIPO;
        
        const opt = document.createElement('option');
        opt.value = i;
        
        // Texto según estado
        let texto = `Equipo ${i}`;
        if (estaLleno) {
          texto += ` - LLENO (${MAX_POR_EQUIPO}/${MAX_POR_EQUIPO})`;
        } else {
          texto += ` - Cupo: ${personasEnEquipo}/${MAX_POR_EQUIPO}`;
        }
        
        opt.textContent = texto;
        
        // Deshabilitar si está lleno
        if (estaLleno) {
          opt.disabled = true;
          opt.classList.add('option-disabled');
        } else {
          opt.classList.add('option-available');
        }
        
        select.appendChild(opt);
      }
      
      // Restaurar selección anterior si sigue disponible
      if (seleccionActual && !select.value) {
        select.value = seleccionActual;
      }
    }

    /* ---------- ACTUALIZAR PANEL VISUAL DE ESTADO ---------- */
    function actualizarPanelEstado(cuenta) {
      contadorEquipos.innerHTML = '';
      
      for (let i = 1; i <= TOTAL_EQUIPOS; i++) {
        const personas = cuenta[i] || 0;
        const estaLleno = personas >= MAX_POR_EQUIPO;
        const porcentaje = (personas / MAX_POR_EQUIPO) * 100;
        
        const col = document.createElement('div');
        col.className = 'col-4 col-md-3 mb-2';
        
        col.innerHTML = `
          <div class="p-2 rounded text-center ${estaLleno ? 'bg-danger' : 'bg-secondary'}">
            <div class="small">Equipo ${i}</div>
            <div class="fw-bold">${personas}/${MAX_POR_EQUIPO}</div>
            <div class="progress mt-1" style="height: 5px;">
              <div class="progress-bar ${estaLleno ? 'bg-warning' : 'bg-success'}" 
                   style="width: ${porcentaje}%"></div>
            </div>
          </div>
        `;
        
        contadorEquipos.appendChild(col);
      }
    }

    /* ---------- ENVIAR DATOS ---------- */
    form.addEventListener('submit', async e => {
      e.preventDefault();
      
      const nombre = form.nombre.value.trim();
      const equipo = form.equipo.value;
      
      // Validaciones
      if (!nombre) {
        msg.innerHTML = '<div class="alert alert-warning mt-3"><i class="fas fa-user-times me-2"></i>Por favor, ingresa tu nombre completo.</div>';
        form.nombre.focus();
        return;
      }
      
      if (!equipo) {
        msg.innerHTML = '<div class="alert alert-warning mt-3"><i class="fas fa-users me-2"></i>Por favor, selecciona un equipo.</div>';
        select.focus();
        return;
      }
      
      // Verificar que el equipo no esté lleno (validación local)
      const equipoNum = parseInt(equipo);
      if (window.estadoEquipos && window.estadoEquipos[equipoNum] >= MAX_POR_EQUIPO) {
        msg.innerHTML = `<div class="alert alert-danger mt-3">
          <i class="fas fa-exclamation-circle me-2"></i>
          <strong>Equipo ${equipo} ya está lleno.</strong> Por favor, selecciona otro equipo.
        </div>`;
        cargarYActualizarEquipos(); // Refrescar estado
        return;
      }
      
      // Enviar datos
      msg.innerHTML = '<div class="alert alert-info mt-3"><i class="fas fa-spinner fa-spin me-2"></i>Registrando en el equipo ' + equipo + '...</div>';
      
      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: new URLSearchParams({nombre, equipo})
        });
        
        const txt = await res.text();
        if (txt === 'ok') {
          msg.innerHTML = `<div class="alert alert-success mt-3">
            <i class="fas fa-check-circle me-2"></i>
            <strong>¡Registro exitoso!</strong><br>
            <strong>${nombre}</strong> ha sido registrado en el <strong>Equipo ${equipo}</strong>.
          </div>`;
          form.nombre.value = ''; // Solo limpiar nombre
          
          // Actualizar lista después de un breve delay
          setTimeout(() => {
            cargarYActualizarEquipos();
            msg.innerHTML += '<div class="alert alert-light mt-2"><small>La lista se ha actualizado. Puedes registrar otra persona.</small></div>';
          }, 1500);
          
        } else {
          msg.innerHTML = '<div class="alert alert-danger mt-3"><i class="fas fa-times-circle me-2"></i>Error en el servidor. Intenta nuevamente.</div>';
        }
      } catch (error) {
        console.error('Error:', error);
        msg.innerHTML = '<div class="alert alert-danger mt-3"><i class="fas fa-wifi-slash me-2"></i>Error de conexión. Verifica tu internet.</div>';
      }
    });

    /* ---------- INICIALIZACIÓN ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      // Cargar equipos al inicio
      cargarYActualizarEquipos();
      
      // Actualizar automáticamente cada 3 segundos
      setInterval(cargarYActualizarEquipos, 3000);
      
      // Actualizar también cuando el usuario interactúa con el select
      select.addEventListener('focus', () => {
        cargarYActualizarEquipos();
      });
    });
  </script>
</body>
</html>
