<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resultados - Asignación de Experimentos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --dark-bg: #1a1a2e;
      --card-bg: #16213e;
      --text-light: #ffffff;
    }
    body {
      background: linear-gradient(135deg, var(--dark-bg) 0%, #0f3460 100%);
      color: var(--text-light);
      min-height: 100vh;
      padding: 20px;
    }
    .card-box {
      max-width: 1200px;
      margin: auto;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }
    .icon-trophy {
      font-size: 3rem;
      color: var(--warning);
    }
    .btn-back {
      background: linear-gradient(135deg, var(--secondary), var(--warning));
      border: none;
      padding: 12px 30px;
      border-radius: 50px;
      color: white;
      font-weight: 600;
      margin-top: 20px;
    }
    .btn-export {
      background: linear-gradient(135deg, var(--success), #229954);
      border: none;
      padding: 8px 20px;
      border-radius: 30px;
      color: white;
      font-weight: 600;
      margin-top: 10px;
    }
    .btn-fijar {
      background: linear-gradient(135deg, var(--warning), #e67e22);
      border: none;
      padding: 6px 15px;
      border-radius: 20px;
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      margin-left: 5px;
    }
    .btn-fijar:disabled {
      background: #7f8c8d;
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-reiniciar {
      background: linear-gradient(135deg, var(--danger), #c0392b);
      border: none;
      padding: 8px 20px;
      border-radius: 30px;
      color: white;
      font-weight: 600;
      margin-top: 10px;
      margin-left: 10px;
    }
    .btn-reiniciar:hover {
      background: linear-gradient(135deg, #c0392b, #a93226);
    }
    .btn-desfijar {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      border: none;
      padding: 8px 20px;
      border-radius: 30px;
      color: white;
      font-weight: 600;
      margin-top: 10px;
      margin-left: 10px;
    }
    .btn-desfijar:hover {
      background: linear-gradient(135deg, #8e44ad, #7d3c98);
    }
    h1, h2, h3, h4, h5, h6 {
      color: white;
    }
    
    /* TABLAS CON TEXTO EN NEGRO PARA MEJOR CONTRASTE */
    .table-dark-custom {
      background-color: #ffffff !important; /* Fondo blanco */
      color: #000000 !important; /* Texto negro */
      border-radius: 10px;
      overflow: hidden;
    }
    .table-dark-custom th {
      background-color: #2c3e50 !important; /* Header oscuro */
      border-color: #34495e;
      color: white !important; /* Texto header en blanco */
      font-weight: 600;
      text-align: center;
      vertical-align: middle;
    }
    .table-dark-custom td {
      border-color: #dee2e6 !important; /* Bordes claros */
      color: #000000 !important; /* Texto de celdas en NEGRO */
      font-weight: 500;
      vertical-align: middle;
      background-color: #ffffff !important; /* Fondo blanco para celdas */
    }
    
    /* Hover para filas */
    .table-dark-custom tbody tr:hover {
      background-color: #f8f9fa !important; /* Gris claro al pasar mouse */
    }
    
    /* Asegurar que todos los textos dentro de las tablas sean negros */
    .table-dark-custom td * {
      color: #000000 !important;
    }
    
    /* Badges mantienen sus colores pero con texto blanco */
    .badge {
      color: white !important;
    }
    
    .table-title {
      border-bottom: 3px solid var(--warning);
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .experiment-badge {
      background: linear-gradient(135deg, #8e44ad, #9b59b6);
      color: white !important; /* Texto blanco en badges */
      font-weight: 500;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
    }
    .team-badge {
      background: linear-gradient(135deg, var(--secondary), #2980b9);
      color: white !important; /* Texto blanco en badges */
      font-weight: 600;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 1rem;
    }
    
    /* Badges de estado - mantienen colores pero texto blanco */
    .badge-fijado {
      background: linear-gradient(135deg, var(--warning), #e67e22);
      color: white !important;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 10px;
      margin-left: 5px;
    }
    .badge-experimento {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white !important;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 10px;
      margin-left: 5px;
    }
    
    /* Modal styling */
    .password-modal .modal-content {
      background: var(--card-bg);
      color: white;
      border-radius: 15px;
    }
    .password-modal .form-control {
      background-color: #2c3e50;
      border: 1px solid #34495e;
      color: white;
    }
    .password-modal .form-control:focus {
      background-color: #34495e;
      border-color: var(--warning);
      box-shadow: 0 0 0 .2rem rgba(243, 156, 18,.25);
      color: white;
    }
    .modal-header {
      border-bottom: 1px solid #34495e;
    }
    .modal-footer {
      border-top: 1px solid #34495e;
    }
    
    /* Sección de cards */
    .section-card {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      border-left: 5px solid var(--warning);
    }
    
    /* Texto muted dentro de las tablas (debe ser gris oscuro) */
    .table-dark-custom .text-muted {
      color: #6c757d !important; /* Gris más oscuro para mejor contraste */
    }
    
    /* Asegurar que los botones dentro de las tablas mantengan su estilo */
    .table-dark-custom .btn-fijar {
      color: white !important; /* Texto blanco en botones */
    }
    
    /* Clase para las tablas de solo lectura (mantener fondo claro) */
    .readonly-table {
      background-color: #ffffff !important;
    }
    .readonly-table td {
      color: #000000 !important; /* Texto negro para mejor contraste */
    }
    
    /* Badges de Bootstrap dentro de tablas */
    .table-dark-custom .bg-success,
    .table-dark-custom .bg-warning,
    .table-dark-custom .bg-danger,
    .table-dark-custom .bg-primary,
    .table-dark-custom .bg-secondary {
      color: white !important; /* Asegurar texto blanco en badges */
    }
    
    /* Botones en la sección de administración */
    .admin-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    /* Checkbox para seleccionar equipos a desfijar */
    .checkbox-equipo {
      transform: scale(1.2);
      margin-right: 8px;
      cursor: pointer;
    }
    
    .equipo-seleccionado {
      background-color: rgba(155, 89, 182, 0.1) !important;
      border-left: 3px solid #9b59b6 !important;
    }
    
    /* Contador de equipos seleccionados */
    .contador-seleccion {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div class="card-box">
    <!-- ENCABEZADO -->
    <div class="text-center mb-5">
      <i class="fas fa-trophy icon-trophy mb-3"></i>
      <h1 class="mb-3">Asignación Final de Experimentos</h1>
      <p class="text-muted">Laboratorio 3 - Farmacia Química</p>
      <div class="alert alert-info d-inline-block">
        <i class="fas fa-lock me-2"></i>
        <strong>Modo Administrador:</strong> Solo los equipos completos (5 personas) pueden fijarse
      </div>
      
      <!-- ACCIONES DE ADMINISTRADOR -->
      <div class="admin-actions justify-content-center mt-4">
        <button class="btn btn-export" onclick="forzarActualizacion()">
          <i class="fas fa-sync-alt me-2"></i>Actualizar Registro
        </button>
        <button class="btn btn-desfijar" onclick="solicitarDesfijar()" id="btn-desfijar">
          <i class="fas fa-unlock me-2"></i>Desfijar Equipos Seleccionados
        </button>
        <button class="btn btn-reiniciar" onclick="solicitarReinicio()">
          <i class="fas fa-redo-alt me-2"></i>Reiniciar Asignación
        </button>
      </div>
      
      <!-- CONTADOR DE EQUIPOS SELECCIONADOS -->
      <div class="mt-3" id="contador-seleccion-container" style="display: none;">
        <span class="contador-seleccion">
          <i class="fas fa-check-square me-1"></i>
          <span id="contador-seleccion">0</span> equipo(s) seleccionado(s)
        </span>
        <small class="text-muted ms-2">Haz clic en las casillas para seleccionar equipos a desfijar</small>
      </div>
    </div>

    <!-- TABLA 1: ASIGNACIÓN DE EXPERIMENTOS A EQUIPOS -->
    <div class="section-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="table-title mb-0">
          <i class="fas fa-flask me-2"></i>Asignación de Experimentos por Equipo
        </h3>
        <div>
          <button class="btn btn-fijar" onclick="solicitarPasswordFijar('todos')" id="btn-fijar-todos">
            <i class="fas fa-lock me-1"></i>Fijar Todos los Equipos Completos
          </button>
          <button class="btn btn-export" onclick="solicitarPassword('experimentos')">
            <i class="fas fa-download me-2"></i>Exportar CSV
          </button>
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="table table-dark-custom readonly-table">
          <thead>
            <tr>
              <th width="5%">Seleccionar</th>
              <th width="15%">Equipo</th>
              <th width="25%">Estado del Registro</th>
              <th width="25%">Experimento Asignado</th>
              <th width="15%">Código</th>
              <th width="15%">Acción</th>
            </tr>
          </thead>
          <tbody id="tabla-experimentos">
            <!-- Datos se cargan dinámicamente -->
          </tbody>
        </table>
      </div>
      
      <!-- INSTRUCCIONES PARA DESFIJAR -->
      <div class="alert alert-warning mt-3" id="instrucciones-desfijar" style="display: none;">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Modo Selección Activado:</strong> 
        <span id="texto-instrucciones"></span>
        <button class="btn btn-sm btn-outline-light ms-2" onclick="cancelarSeleccion()">
          <i class="fas fa-times me-1"></i>Cancelar selección
        </button>
      </div>
    </div>

    <!-- TABLA 2: REGISTROS COMPLETOS DE PERSONAS -->
    <div class="section-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="table-title mb-0">
          <i class="fas fa-users me-2"></i>Registro Completo de Participantes
        </h3>
        <button class="btn btn-export" onclick="solicitarPassword('registros')">
          <i class="fas fa-download me-2"></i>Exportar CSV
        </button>
      </div>
      
      <div class="table-responsive">
        <table class="table table-dark-custom readonly-table">
          <thead>
            <tr>
              <th width="10%">#</th>
              <th width="30%">Nombre Completo</th>
              <th width="15%">Equipo</th>
              <th width="25%">Experimento</th>
              <th width="20%">Fecha de Registro</th>
            </tr>
          </thead>
          <tbody id="tabla-registros-completos">
            <!-- Datos se cargan dinámicamente -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- BOTÓN PARA VOLVER -->
    <div class="text-center mt-5">
      <button class="btn btn-back" onclick="window.location.href='index.html'">
        <i class="fas fa-arrow-left me-2"></i>Volver al Registro
      </button>
    </div>
  </div>

  <!-- MODAL PARA CONTRASEÑA (EXPORTAR) -->
  <div class="modal fade password-modal" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-lock me-2"></i>Autenticación Requerida
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Ingresa la contraseña para exportar los datos:</p>
          <div class="mb-3">
            <input type="password" class="form-control" id="passwordInput" placeholder="Contraseña">
          </div>
          <div id="passwordError" class="alert alert-danger d-none">
            <i class="fas fa-times-circle me-2"></i>Contraseña incorrecta
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" onclick="verificarPassword()">Exportar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL PARA FIJAR EQUIPOS -->
  <div class="modal fade password-modal" id="fijarModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-lock me-2"></i>Fijar Equipo
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>¡Atención!</strong> Al fijar el equipo:
            <ul class="mb-0 mt-2">
              <li>Se asignará un experimento aleatorio</li>
              <li>Los datos no se podrán modificar</li>
              <li>Esta acción es irreversible</li>
            </ul>
          </div>
          <p id="fijar-mensaje"></p>
          <div class="mb-3">
            <label for="passwordFijar" class="form-label">Contraseña de administrador:</label>
            <input type="password" class="form-control" id="passwordFijar" placeholder="Contraseña">
          </div>
          <div id="fijarError" class="alert alert-danger d-none">
            <i class="fas fa-times-circle me-2"></i>Contraseña incorrecta
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-warning" onclick="verificarPasswordFijar()">Fijar Equipo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL PARA DESFIJAR EQUIPOS -->
  <div class="modal fade password-modal" id="desfijarModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-unlock me-2"></i>Desfijar Equipos
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>¡Atención!</strong> Esta acción:
            <ul class="mb-0 mt-2">
              <li>Desbloqueará los equipos seleccionados</li>
              <li>Liberará sus experimentos para nueva asignación</li>
              <li>Los equipos desaparecerán de la vista de usuarios</li>
              <li>Los registros de personas NO se afectan</li>
            </ul>
          </div>
          
          <div id="equipos-a-desfijar" class="mb-3">
            <!-- Aquí se listarán los equipos seleccionados -->
          </div>
          
          <div class="mb-3">
            <label for="passwordDesfijar" class="form-label">Contraseña de administrador:</label>
            <input type="password" class="form-control" id="passwordDesfijar" placeholder="Contraseña">
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="confirmarDesfijar">
            <label class="form-check-label" for="confirmarDesfijar">
              Confirmo que quiero desfijar los equipos seleccionados
            </label>
          </div>
          
          <div id="desfijarError" class="alert alert-danger d-none">
            <i class="fas fa-times-circle me-2"></i>Contraseña incorrecta o acción no confirmada
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-warning" onclick="verificarDesfijar()">Desfijar Equipos</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL PARA REINICIAR ASIGNACIÓN -->
  <div class="modal fade password-modal" id="reiniciarModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-exclamation-triangle me-2 text-danger"></i>Reiniciar Asignación
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger">
            <i class="fas fa-radiation me-2"></i>
            <strong>¡ADVERTENCIA CRÍTICA!</strong> Esta acción:
            <ul class="mb-0 mt-2">
              <li><strong>Eliminará TODAS las asignaciones de experimentos</strong></li>
              <li>Desbloqueará todos los equipos fijados</li>
              <li>Liberará todos los experimentos para nueva asignación</li>
              <li><strong>NO afecta los registros de personas</strong> (Google Sheets)</li>
              <li>Esta acción <strong>NO se puede deshacer</strong></li>
            </ul>
          </div>
          
          <div class="mb-3">
            <label for="passwordReiniciar" class="form-label">Contraseña de administrador:</label>
            <input type="password" class="form-control" id="passwordReiniciar" placeholder="Contraseña">
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="confirmarReinicio">
            <label class="form-check-label" for="confirmarReinicio">
              Confirmo que entiendo que esta acción eliminará todas las asignaciones de experimentos
            </label>
          </div>
          
          <div id="reiniciarError" class="alert alert-danger d-none">
            <i class="fas fa-times-circle me-2"></i>Contraseña incorrecta o acción no confirmada
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" onclick="verificarReinicio()">Reiniciar Asignación</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // CONFIGURACIÓN
    const EXPERIMENTOS = [
      "Humo de brujas",
      "Identificación de iones hierro con tiosianato",
      "Amoníaco con sulfato de cobre",
      "Amoníaco con cloruro de cobalto",
      "Camaleón químico",
      "Botella azul",
      "Volcán de dicromato",
      "Cinta de magnesio",
      "Permanganato con etanol con y sin catalizador",
      "Serpiente del faraón",
      "Galvanoplastia",
      "Electrolisis y pH"
    ];
    
    const PASSWORD = "Lab3Farmacia2024"; // Contraseña para exportar
    const PASSWORD_FIJAR = "AdminLab3"; // Contraseña para fijar equipos y reiniciar
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx9vsQgUypBfUThBnf-Jk7fHnBWui7FRZNDNhO5W6qY8LSMgs6g64kF_53gaGF18T3ofQ/exec';
    const MAX_POR_EQUIPO = 5;
    const TOTAL_EQUIPOS = 12;
    
    // Variables globales
    let tipoExportacion = ''; // 'experimentos' o 'registros'
    let modal = null;
    let fijarModal = null;
    let desfijarModal = null;
    let reiniciarModal = null;
    let equipoAFijar = null; // Para saber qué equipo fijar
    let tipoFijado = ''; // 'individual' o 'todos'
    let todosRegistros = []; // Almacenar todos los registros
    let experimentosDisponiblesGlobal = [...EXPERIMENTOS]; // Copia global de experimentos disponibles
    let equiposSeleccionados = new Set(); // Para equipos seleccionados para desfijar

    // ========== FUNCIONES PARA GOOGLE SHEETS ==========
    
    // Obtener Registros desde Google Sheets
    async function obtenerRegistrosDesdeGoogleSheets() {
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=listar`);
        const data = await response.json();
        
        if (data.status === 'ok') {
          todosRegistros = data.data;
          return todosRegistros;
        }
        return [];
      } catch (error) {
        console.error('Error:', error);
        mostrarMensaje('Error al cargar registros', 'error');
        return [];
      }
    }
    
    // Obtener conteo por equipo desde Google Sheets
    async function obtenerConteoEquipos() {
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=contar`);
        const data = await response.json();
        
        if (data.status === 'ok') {
          return data.conteo;
        }
        return {};
      } catch (error) {
        console.error('Error:', error);
        return {};
      }
    }
    
    // Obtener equipos fijados desde Google Sheets
    async function obtenerEquiposFijados() {
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=obtenerEquiposFijados`);
        const data = await response.json();
        
        if (data.status === 'ok') {
          return data.data;
        }
        return {};
      } catch (error) {
        console.error('Error al obtener equipos fijados:', error);
        return {};
      }
    }
    
    // Guardar equipo fijado en Google Sheets
    async function guardarEquipoFijado(equipo, experimento, codigo) {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'fijarEquipo',
            equipo: equipo,
            experimento: experimento,
            codigo: codigo
          })
        });
        
        const data = await response.json();
        
        if (data.status === 'ok') {
          // Actualizar lista global de experimentos disponibles
          await actualizarExperimentosDisponibles();
          return data;
        } else {
          return { status: 'error', message: data.message || 'Error desconocido' };
        }
        
      } catch (error) {
        console.error('Error al fijar equipo:', error);
        return { status: 'error', message: 'Error de conexión' };
      }
    }
    
    // Desfijar equipo en Google Sheets
    async function desfijarEquipoEnGoogleSheets(equipo) {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'desfijarEquipo',
            equipo: equipo
          })
        });
        
        const data = await response.json();
        return data;
        
      } catch (error) {
        console.error('Error al desfijar equipo:', error);
        return { status: 'error', message: 'Error de conexión' };
      }
    }
    
    // Reiniciar todos los equipos fijados en Google Sheets
    async function reiniciarFijadosEnGoogleSheets() {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'reiniciarFijados'
          })
        });
        
        const data = await response.json();
        return data;
        
      } catch (error) {
        console.error('Error al reiniciar fijados:', error);
        return { status: 'error', message: 'Error de conexión' };
      }
    }
    
    // Actualizar lista de experimentos disponibles
    async function actualizarExperimentosDisponibles() {
      const equiposFijados = await obtenerEquiposFijados();
      const experimentosAsignados = new Set();
      
      // Obtener todos los experimentos ya asignados
      for (let equipo in equiposFijados) {
        if (equiposFijados[equipo].experimento) {
          experimentosAsignados.add(equiposFijados[equipo].experimento);
        }
      }
      
      // Filtrar experimentos disponibles
      experimentosDisponiblesGlobal = EXPERIMENTOS.filter(exp => !experimentosAsignados.has(exp));
      
      return experimentosDisponiblesGlobal;
    }
    
    // ========== FUNCIONES PRINCIPALES ==========
    
    // Fijar todos los equipos completos con experimentos únicos
    async function fijarTodosEquiposCompletos(equiposCompletos) {
      const equiposFijados = await obtenerEquiposFijados();
      const equiposFijadosArray = [];
      
      // Obtener experimentos ya asignados
      const experimentosAsignadosSet = new Set();
      for (let equipo in equiposFijados) {
        if (equiposFijados[equipo].experimento) {
          experimentosAsignadosSet.add(equiposFijados[equipo].experimento);
        }
      }
      
      // Filtrar experimentos disponibles
      let experimentosDisponibles = EXPERIMENTOS.filter(exp => !experimentosAsignadosSet.has(exp));
      
      // Mezclar experimentos disponibles
      for (let i = experimentosDisponibles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [experimentosDisponibles[i], experimentosDisponibles[j]] = [experimentosDisponibles[j], experimentosDisponibles[i]];
      }
      
      let expIndex = 0;
      
      // Asignar experimentos únicos a equipos completos
      for (let equipo = 1; equipo <= TOTAL_EQUIPOS; equipo++) {
        if (equiposCompletos[equipo] && !equiposFijados[equipo]) {
          if (expIndex < experimentosDisponibles.length) {
            const experimento = experimentosDisponibles[expIndex];
            const codigo = `EXP-${equipo.toString().padStart(2, '0')}`;
            
            // Guardar en Google Sheets
            const resultado = await guardarEquipoFijado(equipo, experimento, codigo);
            
            if (resultado.status === 'ok') {
              equiposFijadosArray.push(equipo);
              expIndex++;
            }
          } else {
            // Si no hay más experimentos disponibles
            mostrarMensaje(`No hay suficientes experimentos disponibles para todos los equipos completos`, 'warning');
            break;
          }
        }
      }
      
      return equiposFijadosArray;
    }
    
    // Verificar qué equipos están completos (5 personas)
    async function verificarEquiposCompletos() {
      const conteo = await obtenerConteoEquipos();
      
      // Crear objeto de equipos completos
      const equiposCompletos = {};
      for (let i = 1; i <= TOTAL_EQUIPOS; i++) {
        equiposCompletos[i] = (conteo[i] || 0) === MAX_POR_EQUIPO;
      }
      
      return equiposCompletos;
    }
    
    // Asignar experimentos a equipos (experimentos únicos para cada equipo)
    async function asignarExperimentos(equiposCompletos) {
      const equiposFijados = await obtenerEquiposFijados();
      const experimentosAsignados = {};
      
      // Obtener experimentos ya asignados a equipos fijados
      const experimentosUsados = new Set();
      for (let equipo in equiposFijados) {
        if (equiposFijados[equipo].experimento) {
          experimentosUsados.add(equiposFijados[equipo].experimento);
        }
      }
      
      // Crear lista de experimentos disponibles (no usados por equipos fijados)
      const experimentosDisponibles = EXPERIMENTOS.filter(exp => !experimentosUsados.has(exp));
      
      // Mezclar experimentos disponibles
      for (let i = experimentosDisponibles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [experimentosDisponibles[i], experimentosDisponibles[j]] = [experimentosDisponibles[j], experimentosDisponibles[i]];
      }
      
      let expIndex = 0;
      
      // Asignar experimentos
      for (let equipo = 1; equipo <= TOTAL_EQUIPOS; equipo++) {
        if (equiposFijados[equipo]) {
          // Si el equipo está fijado, usar el experimento guardado
          experimentosAsignados[equipo] = {
            nombre: equiposFijados[equipo].experimento,
            codigo: equiposFijados[equipo].codigo,
            fijado: true,
            asignado: true
          };
        } else if (equiposCompletos[equipo]) {
          // Si el equipo está completo pero no fijado
          // Solo mostrar "Pendiente de asignación" si hay experimentos disponibles
          if (expIndex < experimentosDisponibles.length) {
            experimentosAsignados[equipo] = {
              nombre: "Pendiente de asignación",
              codigo: `EXP-${equipo.toString().padStart(2, '0')}`,
              fijado: false,
              asignado: false,
              disponible: true
            };
          } else {
            experimentosAsignados[equipo] = {
              nombre: "Sin experimento disponible",
              codigo: `EXP-${equipo.toString().padStart(2, '0')}`,
              fijado: false,
              asignado: false,
              disponible: false
            };
          }
        } else {
          // Si el equipo no está completo
          experimentosAsignados[equipo] = {
            nombre: "Equipo incompleto",
            codigo: `EXP-${equipo.toString().padStart(2, '0')}`,
            fijado: false,
            asignado: false,
            disponible: false
          };
        }
      }
      
      return experimentosAsignados;
    }
    
    // Obtener un experimento aleatorio único que no haya sido asignado
    async function obtenerExperimentoUnico() {
      const equiposFijados = await obtenerEquiposFijados();
      const experimentosAsignados = new Set();
      
      // Obtener todos los experimentos ya asignados
      for (let equipo in equiposFijados) {
        if (equiposFijados[equipo].experimento) {
          experimentosAsignados.add(equiposFijados[equipo].experimento);
        }
      }
      
      // Filtrar experimentos disponibles
      const experimentosDisponibles = EXPERIMENTOS.filter(exp => !experimentosAsignados.has(exp));
      
      if (experimentosDisponibles.length === 0) {
        return null; // No hay experimentos disponibles
      }
      
      // Seleccionar aleatoriamente uno de los disponibles
      const randomIndex = Math.floor(Math.random() * experimentosDisponibles.length);
      return experimentosDisponibles[randomIndex];
    }
    
    // Cargar tabla de experimentos
    async function cargarTablaExperimentos() {
      const tabla = document.getElementById('tabla-experimentos');
      const conteo = await obtenerConteoEquipos();
      const equiposCompletos = await verificarEquiposCompletos();
      const experimentosAsignados = await asignarExperimentos(equiposCompletos);
      const equiposFijados = await obtenerEquiposFijados();
      
      // Actualizar lista de experimentos disponibles
      await actualizarExperimentosDisponibles();
      
      tabla.innerHTML = '';
      
      for (let equipo = 1; equipo <= TOTAL_EQUIPOS; equipo++) {
        const personas = conteo[equipo] || 0;
        const completado = equiposCompletos[equipo];
        const fijado = equiposFijados[equipo] ? true : false;
        const experimento = experimentosAsignados[equipo];
        const seleccionado = equiposSeleccionados.has(equipo);
        
        // Determinar si se puede fijar este equipo
        const puedeFijarse = completado && !fijado && experimentosDisponiblesGlobal.length > 0;
        
        const fila = document.createElement('tr');
        fila.id = `fila-equipo-${equipo}`;
        if (seleccionado) {
          fila.classList.add('equipo-seleccionado');
        }
        
        fila.innerHTML = `
          <td class="text-center">
            ${fijado ? `
              <input type="checkbox" class="checkbox-equipo" 
                     data-equipo="${equipo}" 
                     onchange="toggleSeleccionEquipo(${equipo})"
                     ${seleccionado ? 'checked' : ''}>
            ` : ''}
          </td>
          <td class="text-center">
            <span class="team-badge">Equipo ${equipo}</span>
            ${fijado ? '<span class="badge-fijado"><i class="fas fa-lock me-1"></i>FIJADO</span>' : ''}
          </td>
          <td>
            <div class="d-flex align-items-center">
              <div class="me-3">
                <span class="badge ${completado ? 'bg-success' : 'bg-warning'}">
                  ${personas}/${MAX_POR_EQUIPO}
                </span>
              </div>
              <div>
                <div><strong>${completado ? 'COMPLETO' : 'INCOMPLETO'}</strong></div>
                <small class="text-muted">${completado ? 
                  (experimentosDisponiblesGlobal.length > 0 ? 
                    'Listo para asignar experimento' : 
                    'No hay experimentos disponibles') : 
                  'Faltan ' + (MAX_POR_EQUIPO - personas) + ' personas'}</small>
              </div>
            </div>
          </td>
          <td>
            <span class="experiment-badge" style="${!experimento.asignado ? 'background: linear-gradient(135deg, #95a5a6, #7f8c8d) !important;' : ''}">
              ${experimento.nombre}
            </span>
            ${experimento.asignado ? '<span class="badge-experimento"><i class="fas fa-flask me-1"></i>ASIGNADO</span>' : ''}
          </td>
          <td class="text-center">${experimento.codigo}</td>
          <td class="text-center">
            <button class="btn btn-fijar" 
                    onclick="solicitarPasswordFijar(${equipo})" 
                    ${!puedeFijarse ? 'disabled' : ''}>
              <i class="fas ${fijado ? 'fa-lock' : 'fa-lock-open'} me-1"></i>
              ${fijado ? 'Fijado' : 'Fijar'}
            </button>
          </td>
        `;
        tabla.appendChild(fila);
      }
      
      // Actualizar estado del botón "Fijar Todos"
      const equiposCompletosList = Object.values(equiposCompletos).filter(v => v === true).length;
      const equiposCompletosFijados = Object.keys(equiposFijados).filter(e => equiposCompletos[e]).length;
      const btnFijarTodos = document.getElementById('btn-fijar-todos');
      const puedeFijarTodos = equiposCompletosList > equiposCompletosFijados && experimentosDisponiblesGlobal.length >= (equiposCompletosList - equiposCompletosFijados);
      
      btnFijarTodos.disabled = !puedeFijarTodos;
      btnFijarTodos.textContent = puedeFijarTodos ? 
        `Fijar ${equiposCompletosList - equiposCompletosFijados} Equipos Completos` : 
        (experimentosDisponiblesGlobal.length === 0 ? 
          'No hay experimentos disponibles' : 
          'No hay equipos completos para fijar');
      
      // Actualizar interfaz de selección
      actualizarInterfazSeleccion();
      
      return experimentosAsignados;
    }
    
    // Toggle selección de equipo
    function toggleSeleccionEquipo(equipo) {
      const checkbox = document.querySelector(`.checkbox-equipo[data-equipo="${equipo}"]`);
      const fila = document.getElementById(`fila-equipo-${equipo}`);
      
      if (checkbox.checked) {
        equiposSeleccionados.add(equipo);
        fila.classList.add('equipo-seleccionado');
      } else {
        equiposSeleccionados.delete(equipo);
        fila.classList.remove('equipo-seleccionado');
      }
      
      actualizarContadorSeleccion();
      actualizarInterfazSeleccion();
    }
    
    // Actualizar contador de selección
    function actualizarContadorSeleccion() {
      const contador = document.getElementById('contador-seleccion');
      const container = document.getElementById('contador-seleccion-container');
      
      if (equiposSeleccionados.size > 0) {
        contador.textContent = equiposSeleccionados.size;
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }
    
    // Actualizar interfaz de selección
    function actualizarInterfazSeleccion() {
      const btnDesfijar = document.getElementById('btn-desfijar');
      const instrucciones = document.getElementById('instrucciones-desfijar');
      const textoInstrucciones = document.getElementById('texto-instrucciones');
      
      if (equiposSeleccionados.size > 0) {
        btnDesfijar.disabled = false;
        instrucciones.style.display = 'block';
        textoInstrucciones.textContent = `Seleccionados ${equiposSeleccionados.size} equipo(s) para desfijar. Haz clic en "Desfijar Equipos Seleccionados" para continuar.`;
      } else {
        btnDesfijar.disabled = true;
        instrucciones.style.display = 'none';
      }
    }
    
    // Cancelar selección
    function cancelarSeleccion() {
      // Desmarcar todos los checkboxes
      document.querySelectorAll('.checkbox-equipo:checked').forEach(checkbox => {
        checkbox.checked = false;
        const equipo = parseInt(checkbox.getAttribute('data-equipo'));
        equiposSeleccionados.delete(equipo);
        const fila = document.getElementById(`fila-equipo-${equipo}`);
        if (fila) fila.classList.remove('equipo-seleccionado');
      });
      
      actualizarContadorSeleccion();
      actualizarInterfazSeleccion();
    }
    
    // Cargar tabla de registros completos
    async function cargarTablaRegistrosCompletos(experimentosAsignados) {
      const tabla = document.getElementById('tabla-registros-completos');
      const registros = await obtenerRegistrosDesdeGoogleSheets();
      
      tabla.innerHTML = '';
      
      if (registros.length === 0) {
        tabla.innerHTML = `
          <tr>
            <td colspan="5" class="text-center py-5">
              <i class="fas fa-inbox fa-2x mb-3 d-block"></i>
              No hay registros aún
            </td>
          </tr>
        `;
        return;
      }
      
      registros.forEach((registro, index) => {
        const experimento = experimentosAsignados[registro.equipo] || {nombre: 'No asignado', codigo: 'N/A'};
        
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td class="text-center">${index + 1}</td>
          <td><strong>${registro.nombre}</strong></td>
          <td class="text-center">
            <span class="badge bg-primary">Equipo ${registro.equipo}</span>
          </td>
          <td><strong>${experimento.nombre}</strong></td>
          <td>${registro.fecha}</td>
        `;
        tabla.appendChild(fila);
      });
    }
    
    // FORZAR ACTUALIZACIÓN DEL REGISTRO
    async function forzarActualizacion() {
      try {
        mostrarMensaje('Actualizando registro desde Google Sheets...', 'info');
        
        // Cargar datos inmediatamente
        const experimentosAsignados = await cargarTablaExperimentos();
        await cargarTablaRegistrosCompletos(experimentosAsignados);
        
        mostrarMensajeExito('Registro actualizado correctamente');
      } catch (error) {
        console.error('Error al actualizar:', error);
        mostrarMensaje('Error al actualizar el registro', 'error');
      }
    }
    
    // SOLICITAR DESFIJAR EQUIPOS
    function solicitarDesfijar() {
      if (equiposSeleccionados.size === 0) {
        mostrarMensaje('Primero selecciona los equipos que quieres desfijar', 'warning');
        return;
      }
      
      // Mostrar lista de equipos a desfijar
      const container = document.getElementById('equipos-a-desfijar');
      container.innerHTML = '';
      
      const equiposArray = Array.from(equiposSeleccionados).sort((a, b) => a - b);
      
      let html = '<p>Equipos seleccionados para desfijar:</p><div class="d-flex flex-wrap gap-2">';
      
      equiposArray.forEach(equipo => {
        html += `<span class="badge bg-warning">Equipo ${equipo}</span>`;
      });
      
      html += '</div>';
      container.innerHTML = html;
      
      // Resetear modal
      document.getElementById('passwordDesfijar').value = '';
      document.getElementById('confirmarDesfijar').checked = false;
      document.getElementById('desfijarError').classList.add('d-none');
      
      if (!desfijarModal) {
        desfijarModal = new bootstrap.Modal(document.getElementById('desfijarModal'));
      }
      
      desfijarModal.show();
    }
    
    // SOLICITAR REINICIO DE ASIGNACIÓN
    function solicitarReinicio() {
      // Resetear modal de reinicio
      document.getElementById('passwordReiniciar').value = '';
      document.getElementById('confirmarReinicio').checked = false;
      document.getElementById('reiniciarError').classList.add('d-none');
      
      if (!reiniciarModal) {
        reiniciarModal = new bootstrap.Modal(document.getElementById('reiniciarModal'));
      }
      
      reiniciarModal.show();
    }
    
    // Función para solicitar contraseña (exportar)
    function solicitarPassword(tipo) {
      tipoExportacion = tipo;
      document.getElementById('passwordInput').value = '';
      document.getElementById('passwordError').classList.add('d-none');
      
      if (!modal) {
        modal = new bootstrap.Modal(document.getElementById('passwordModal'));
      }
      
      modal.show();
    }
    
    // Función para solicitar contraseña para fijar
    function solicitarPasswordFijar(equipo) {
      equipoAFijar = equipo;
      
      if (equipo === 'todos') {
        tipoFijado = 'todos';
        const equiposCompletosFijables = calcularEquiposCompletosFijables();
        document.getElementById('fijar-mensaje').textContent = 
          `Se fijarán ${equiposCompletosFijables} equipo(s) completos y se asignarán experimentos únicos.`;
      } else {
        tipoFijado = 'individual';
        document.getElementById('fijar-mensaje').textContent = 
          `Se fijará el EQUIPO ${equipo} y se asignará un experimento único.`;
      }
      
      document.getElementById('passwordFijar').value = '';
      document.getElementById('fijarError').classList.add('d-none');
      
      if (!fijarModal) {
        fijarModal = new bootstrap.Modal(document.getElementById('fijarModal'));
      }
      
      fijarModal.show();
    }
    
    // Calcular cuántos equipos completos se pueden fijar
    async function calcularEquiposCompletosFijables() {
      const equiposCompletos = await verificarEquiposCompletos();
      const equiposFijados = await obtenerEquiposFijados();
      
      let equiposCompletosNoFijados = 0;
      for (let equipo = 1; equipo <= TOTAL_EQUIPOS; equipo++) {
        if (equiposCompletos[equipo] && !equiposFijados[equipo]) {
          equiposCompletosNoFijados++;
        }
      }
      
      return Math.min(equiposCompletosNoFijados, experimentosDisponiblesGlobal.length);
    }
    
    // Verificar contraseña para exportar
    function verificarPassword() {
      const passwordIngresada = document.getElementById('passwordInput').value;
      const errorDiv = document.getElementById('passwordError');
      
      if (passwordIngresada === PASSWORD) {
        errorDiv.classList.add('d-none');
        modal.hide();
        
        // Exportar según el tipo
        if (tipoExportacion === 'experimentos') {
          exportarExperimentosCSV();
        } else if (tipoExportacion === 'registros') {
          exportarRegistrosCSV();
        }
        
        // Mostrar mensaje de éxito
        mostrarMensajeExito('Archivo CSV generado correctamente.');
        
      } else {
        errorDiv.classList.remove('d-none');
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
      }
    }
    
    // Verificar contraseña para fijar
    async function verificarPasswordFijar() {
      const passwordIngresada = document.getElementById('passwordFijar').value;
      const errorDiv = document.getElementById('fijarError');
      
      if (passwordIngresada === PASSWORD_FIJAR) {
        errorDiv.classList.add('d-none');
        fijarModal.hide();
        
        // Obtener equipos completos actualizados
        const equiposCompletos = await verificarEquiposCompletos();
        
        if (tipoFijado === 'todos') {
          // Verificar que haya experimentos disponibles
          if (experimentosDisponiblesGlobal.length === 0) {
            mostrarMensaje('No hay experimentos disponibles para asignar', 'error');
            return;
          }
          
          // Fijar todos los equipos completos
          const equiposFijados = await fijarTodosEquiposCompletos(equiposCompletos);
          
          if (equiposFijados.length > 0) {
            mostrarMensajeExito(`¡${equiposFijados.length} equipo(s) completos han sido fijados con experimentos únicos!`);
          } else {
            mostrarMensaje('No hay equipos completos para fijar o no hay experimentos disponibles', 'warning');
          }
        } else {
          // Verificar que el equipo esté completo
          if (!equiposCompletos[equipoAFijar]) {
            mostrarMensaje(`El equipo ${equipoAFijar} no está completo (5 personas)`, 'error');
            return;
          }
          
          // Verificar que haya experimentos disponibles
          if (experimentosDisponiblesGlobal.length === 0) {
            mostrarMensaje('No hay experimentos disponibles para asignar', 'error');
            return;
          }
          
          // Fijar equipo individual con experimento único
          await fijarEquipoIndividual(equipoAFijar);
          mostrarMensajeExito(`¡Equipo ${equipoAFijar} fijado con experimento único!`);
        }
        
        // Recargar la tabla
        setTimeout(async () => {
          const experimentosAsignados = await cargarTablaExperimentos();
          await cargarTablaRegistrosCompletos(experimentosAsignados);
        }, 500);
        
      } else {
        errorDiv.classList.remove('d-none');
        document.getElementById('passwordFijar').value = '';
        document.getElementById('passwordFijar').focus();
      }
    }
    
    // Verificar contraseña para desfijar
    async function verificarDesfijar() {
      const passwordIngresada = document.getElementById('passwordDesfijar').value;
      const confirmado = document.getElementById('confirmarDesfijar').checked;
      const errorDiv = document.getElementById('desfijarError');
      
      if (passwordIngresada === PASSWORD_FIJAR && confirmado) {
        errorDiv.classList.add('d-none');
        desfijarModal.hide();
        
        // Ejecutar desfijado
        const equiposArray = Array.from(equiposSeleccionados);
        await desfijarEquiposSeleccionados(equiposArray);
        
      } else {
        errorDiv.classList.remove('d-none');
        if (!confirmado) {
          errorDiv.innerHTML = '<i class="fas fa-times-circle me-2"></i>Debes confirmar la acción marcando la casilla';
        } else {
          errorDiv.innerHTML = '<i class="fas fa-times-circle me-2"></i>Contraseña incorrecta';
        }
        document.getElementById('passwordDesfijar').value = '';
      }
    }
    
    // Verificar contraseña para reiniciar
    async function verificarReinicio() {
      const passwordIngresada = document.getElementById('passwordReiniciar').value;
      const confirmado = document.getElementById('confirmarReinicio').checked;
      const errorDiv = document.getElementById('reiniciarError');
      
      if (passwordIngresada === PASSWORD_FIJAR && confirmado) {
        errorDiv.classList.add('d-none');
        reiniciarModal.hide();
        
        // Ejecutar reinicio
        await reiniciarAsignaciones();
        
      } else {
        errorDiv.classList.remove('d-none');
        if (!confirmado) {
          errorDiv.innerHTML = '<i class="fas fa-times-circle me-2"></i>Debes confirmar la acción marcando la casilla';
        } else {
          errorDiv.innerHTML = '<i class="fas fa-times-circle me-2"></i>Contraseña incorrecta';
        }
        document.getElementById('passwordReiniciar').value = '';
      }
    }
    
    // Fijar equipo individual con experimento único
    async function fijarEquipoIndividual(equipo) {
      // Obtener experimento único disponible
      const experimentoUnico = await obtenerExperimentoUnico();
      
      if (!experimentoUnico) {
        mostrarMensaje('No hay experimentos disponibles para asignar', 'error');
        return;
      }
      
      const codigo = `EXP-${equipo.toString().padStart(2, '0')}`;
      
      await guardarEquipoFijado(equipo, experimentoUnico, codigo);
    }
    
    // Desfijar equipos seleccionados
    async function desfijarEquiposSeleccionados(equipos) {
      try {
        // Desfijar cada equipo individualmente
        for (const equipo of equipos) {
          const resultado = await desfijarEquipoEnGoogleSheets(equipo);
          if (resultado.status !== 'ok') {
            console.error(`Error al desfijar equipo ${equipo}:`, resultado.message);
          }
        }
        
        // Actualizar lista de experimentos disponibles
        await actualizarExperimentosDisponibles();
        
        // Limpiar selección
        equiposSeleccionados.clear();
        actualizarContadorSeleccion();
        
        // Mostrar mensaje de éxito
        mostrarMensajeExito(`¡${equipos.length} equipo(s) han sido desfijados correctamente!`);
        
        // Recargar la tabla
        setTimeout(async () => {
          const experimentosAsignados = await cargarTablaExperimentos();
          await cargarTablaRegistrosCompletos(experimentosAsignados);
        }, 500);
        
      } catch (error) {
        console.error('Error al desfijar equipos:', error);
        mostrarMensaje('Error al desfijar los equipos', 'error');
      }
    }
    
    // Reiniciar todas las asignaciones
    async function reiniciarAsignaciones() {
      try {
        const resultado = await reiniciarFijadosEnGoogleSheets();
        
        if (resultado.status === 'ok') {
          // Reiniciar lista de experimentos disponibles
          experimentosDisponiblesGlobal = [...EXPERIMENTOS];
          
          // Limpiar selección
          equiposSeleccionados.clear();
          actualizarContadorSeleccion();
          
          // Mostrar mensaje de éxito
          mostrarMensajeExito('¡Todas las asignaciones han sido reiniciadas! Los experimentos están disponibles para nueva asignación.');
          
          // Recargar la tabla
          setTimeout(async () => {
            const experimentosAsignados = await cargarTablaExperimentos();
            await cargarTablaRegistrosCompletos(experimentosAsignados);
          }, 500);
        } else {
          mostrarMensaje('Error al reiniciar asignaciones: ' + resultado.message, 'error');
        }
        
      } catch (error) {
        console.error('Error al reiniciar asignaciones:', error);
        mostrarMensaje('Error al reiniciar las asignaciones', 'error');
      }
    }
    
    // Exportar tabla de experimentos como CSV
    async function exportarExperimentosCSV() {
      const conteo = await obtenerConteoEquipos();
      const equiposCompletos = await verificarEquiposCompletos();
      const experimentosAsignados = await asignarExperimentos(equiposCompletos);
      const equiposFijados = await obtenerEquiposFijados();
      
      // Crear contenido CSV
      let csvContent = "Equipo,Personas Registradas,Estado,Experimento Asignado,Código,Fijado,Última Actualización\n";
      
      for (let equipo = 1; equipo <= TOTAL_EQUIPOS; equipo++) {
        const personas = conteo[equipo] || 0;
        const estado = equiposCompletos[equipo] ? "COMPLETO" : "INCOMPLETO";
        const experimento = experimentosAsignados[equipo];
        const fijado = equiposFijados[equipo] ? "SI" : "NO";
        const fecha = new Date().toLocaleString('es-ES');
        
        csvContent += `"Equipo ${equipo}",${personas},"${estado}","${experimento.nombre}","${experimento.codigo}","${fijado}","${fecha}"\n`;
      }
      
      // Crear archivo CSV
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      // Crear enlace para descargar
      const a = document.createElement('a');
      a.href = url;
      a.download = `asignacion_experimentos_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // Exportar tabla de registros como CSV
    async function exportarRegistrosCSV() {
      const registros = await obtenerRegistrosDesdeGoogleSheets();
      const equiposCompletos = await verificarEquiposCompletos();
      const experimentosAsignados = await asignarExperimentos(equiposCompletos);
      const equiposFijados = await obtenerEquiposFijados();
      
      // Crear contenido CSV
      let csvContent = "#,Nombre Completo,Equipo,Experimento Asignado,Fecha de Registro,Equipo Fijado\n";
      
      registros.forEach((registro, index) => {
        const experimento = experimentosAsignados[registro.equipo] || {nombre: 'No asignado'};
        const fijado = equiposFijados[registro.equipo] ? "SI" : "NO";
        
        csvContent += `${index + 1},"${registro.nombre}","Equipo ${registro.equipo}","${experimento.nombre}","${registro.fecha}","${fijado}"\n`;
      });
      
      // Crear archivo CSV
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      // Crear enlace para descargar
      const a = document.createElement('a');
      a.href = url;
      a.download = `registros_completos_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // Mostrar mensaje de éxito
    function mostrarMensajeExito(mensaje) {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
      alertDiv.style.zIndex = '9999';
      alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        <strong>¡Éxito!</strong> ${mensaje}
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      // Auto-eliminar después de 5 segundos
      setTimeout(() => {
        if (alertDiv.parentNode) {
          const bsAlert = new bootstrap.Alert(alertDiv);
          bsAlert.close();
        }
      }, 5000);
    }
    
    // Mostrar mensaje general
    function mostrarMensaje(mensaje, tipo = 'info') {
      const tipos = {
        success: 'alert-success',
        error: 'alert-danger',
        warning: 'alert-warning',
        info: 'alert-info'
      };
      
      const iconos = {
        success: 'fa-check-circle',
        error: 'fa-times-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };
      
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert ${tipos[tipo]} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
      alertDiv.style.zIndex = '9999';
      alertDiv.innerHTML = `
        <i class="fas ${iconos[tipo]} me-2"></i>
        ${mensaje}
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      // Auto-eliminar después de 5 segundos
      setTimeout(() => {
        if (alertDiv.parentNode) {
          const bsAlert = new bootstrap.Alert(alertDiv);
          bsAlert.close();
        }
      }, 5000);
    }
    
    // Inicializar la página
    document.addEventListener('DOMContentLoaded', async function() {
      // Inicializar modales
      modal = new bootstrap.Modal(document.getElementById('passwordModal'));
      fijarModal = new bootstrap.Modal(document.getElementById('fijarModal'));
      desfijarModal = new bootstrap.Modal(document.getElementById('desfijarModal'));
      reiniciarModal = new bootstrap.Modal(document.getElementById('reiniciarModal'));
      
      // Inicializar lista de experimentos disponibles
      await actualizarExperimentosDisponibles();
      
      // Cargar datos iniciales
      await cargarDatos();
      
      // Actualizar automáticamente cada 3 segundos
      setInterval(async () => {
        await cargarDatos();
      }, 3000);
    });
    
    // Función para cargar todos los datos
    async function cargarDatos() {
      try {
        const experimentosAsignados = await cargarTablaExperimentos();
        await cargarTablaRegistrosCompletos(experimentosAsignados);
      } catch (error) {
        console.error('Error al cargar datos:', error);
      }
    }
  </script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
