<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Experimentos Asignados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --dark-bg: #1a1a2e;
      --card-bg: #16213e;
      --text-light: #ffffff;
    }
    body {
      background: linear-gradient(135deg, var(--dark-bg) 0%, #0f3460 100%);
      color: var(--text-light);
      min-height: 100vh;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .card-box {
      max-width: 1000px;
      margin: auto;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }
    .icon-flask {
      font-size: 3rem;
      color: var(--warning);
    }
    .btn-back {
      background: linear-gradient(135deg, var(--secondary), var(--warning));
      border: none;
      padding: 12px 30px;
      border-radius: 50px;
      color: white;
      font-weight: 600;
      margin-top: 20px;
    }
    h1, h2, h3, h4, h5, h6 {
      color: white;
    }
    
    /* TABLAS CON TEXTO EN NEGRO PARA MEJOR CONTRASTE */
    .table-dark-custom {
      background-color: #ffffff !important; /* Fondo blanco */
      color: #000000 !important; /* Texto negro */
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 0;
    }
    .table-dark-custom th {
      background-color: #2c3e50 !important; /* Header oscuro */
      border-color: #34495e;
      color: white !important; /* Texto header en blanco */
      font-weight: 600;
      text-align: center;
      vertical-align: middle;
      font-size: 1rem;
    }
    .table-dark-custom td {
      border-color: #dee2e6 !important; /* Bordes claros */
      color: #000000 !important; /* Texto de celdas en NEGRO */
      font-weight: 500;
      vertical-align: middle;
      background-color: #ffffff !important; /* Fondo blanco para celdas */
    }
    
    /* Hover para filas */
    .table-dark-custom tbody tr:hover {
      background-color: #f8f9fa !important; /* Gris claro al pasar mouse */
    }
    
    /* Asegurar que todos los textos dentro de las tablas sean negros */
    .table-dark-custom td * {
      color: #000000 !important;
    }
    
    /* Badges mantienen sus colores pero con texto blanco */
    .badge {
      color: white !important;
    }
    
    .table-title {
      border-bottom: 3px solid var(--warning);
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .experiment-badge {
      background: linear-gradient(135deg, #8e44ad, #9b59b6);
      color: white !important; /* Texto blanco en badges */
      font-weight: 500;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
    }
    .team-badge {
      background: linear-gradient(135deg, var(--secondary), #2980b9);
      color: white !important; /* Texto blanco en badges */
      font-weight: 600;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 1rem;
    }
    
    /* Badges de estado - mantienen colores pero texto blanco */
    .badge-fijado {
      background: linear-gradient(135deg, var(--warning), #e67e22);
      color: white !important;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 10px;
      margin-left: 5px;
    }
    .badge-experimento {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white !important;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 10px;
      margin-left: 5px;
    }
    
    /* Sección de cards */
    .section-card {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      border-left: 5px solid var(--warning);
    }
    
    /* Texto muted dentro de las tablas (debe ser gris oscuro) */
    .table-dark-custom .text-muted {
      color: #6c757d !important; /* Gris más oscuro para mejor contraste */
    }
    
    /* Clase para las tablas de solo lectura (mantener fondo claro) */
    .readonly-table {
      background-color: #ffffff !important;
    }
    .readonly-table td {
      color: #000000 !important; /* Texto negro para mejor contraste */
    }
    
    /* Badges de Bootstrap dentro de tablas */
    .table-dark-custom .bg-success,
    .table-dark-custom .bg-warning,
    .table-dark-custom .bg-danger,
    .table-dark-custom .bg-primary,
    .table-dark-custom .bg-secondary {
      color: white !important; /* Asegurar texto blanco en badges */
    }
    
    /* Estilos específicos para esta página */
    .info-box {
      background: rgba(52, 152, 219, 0.1);
      border-left: 4px solid var(--secondary);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 25px;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-completo {
      background-color: var(--success);
    }
    
    .status-pendiente {
      background-color: var(--warning);
    }
    
    .status-incompleto {
      background-color: var(--danger);
    }
    
    .experiment-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .experiment-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .experiment-card.fijado {
      border-left: 5px solid var(--warning);
    }
    
    .experiment-card.pendiente {
      border-left: 5px solid var(--secondary);
    }
    
    .counter-badge {
      font-size: 0.8rem;
      padding: 3px 10px;
      border-radius: 20px;
      margin-left: 10px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .card-box {
        padding: 15px;
      }
      
      .table-responsive {
        font-size: 0.9rem;
      }
      
      .team-badge, .experiment-badge {
        font-size: 0.85rem;
        padding: 4px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="card-box">
    <!-- ENCABEZADO -->
    <div class="text-center mb-5">
      <i class="fas fa-flask icon-flask mb-3"></i>
      <h1 class="mb-3">Consulta de Experimentos Asignados</h1>
      <p class="text-muted">Laboratorio 3 - Farmacia Química</p>
      <div class="info-box">
        <p class="mb-0">
          <i class="fas fa-info-circle me-2"></i>
          Esta página muestra únicamente los equipos <strong>completos</strong> con sus experimentos asignados.
          Los equipos incompletos no se muestran aquí.
        </p>
      </div>
    </div>

    <!-- CONTADOR DE EQUIPOS COMPLETOS -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card bg-dark border-success">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-check-circle me-2 text-success"></i>Equipos Completos
            </h5>
            <h2 class="mb-0" id="contador-completos">0</h2>
            <p class="text-muted mb-0">de 12 equipos totales</p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card bg-dark border-warning">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-flask me-2 text-warning"></i>Experimentos Asignados
            </h5>
            <h2 class="mb-0" id="contador-experimentos">0</h2>
            <p class="text-muted mb-0">de 12 experimentos disponibles</p>
          </div>
        </div>
      </div>
    </div>

    <!-- TABLA DE EQUIPOS COMPLETOS -->
    <div class="section-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="table-title mb-0">
          <i class="fas fa-users me-2"></i>Equipos Completos con Experimentos Asignados
        </h3>
        <button class="btn btn-success btn-sm" onclick="actualizarDatos()">
          <i class="fas fa-sync-alt me-2"></i>Actualizar
        </button>
      </div>
      
      <div id="contenedor-equipos">
        <!-- Aquí se cargarán las cards de equipos completos -->
        <div class="text-center py-5" id="mensaje-carga">
          <div class="spinner-border text-warning" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-3">Cargando información de equipos...</p>
        </div>
      </div>
      
      <!-- Mensaje cuando no hay equipos completos -->
      <div id="mensaje-sin-equipos" class="text-center py-5 d-none">
        <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
        <h4 class="text-muted">No hay equipos completos aún</h4>
        <p class="text-muted">Los equipos aparecerán aquí cuando estén completos (5 personas cada uno)</p>
      </div>
    </div>

    <!-- INFORMACIÓN ADICIONAL -->
    <div class="alert alert-info mt-4">
      <div class="row">
        <div class="col-md-4">
          <div class="d-flex align-items-center mb-2">
            <span class="status-indicator status-completo"></span>
            <span>Equipo completo y fijado</span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="d-flex align-items-center mb-2">
            <span class="status-indicator status-pendiente"></span>
            <span>Equipo completo pero pendiente</span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="d-flex align-items-center mb-2">
            <span class="status-indicator status-incompleto"></span>
            <span>Equipo incompleto (no se muestra)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- BOTONES DE NAVEGACIÓN -->
    <div class="text-center mt-5">
      <button class="btn btn-back" onclick="window.location.href='index.html'">
        <i class="fas fa-arrow-left me-2"></i>Volver al Registro
      </button>
      <button class="btn btn-secondary ms-2" onclick="window.location.href='resultados.html'">
        <i class="fas fa-chart-bar me-2"></i>Vista del Administrador
      </button>
    </div>
    
    <!-- FIRMA Y CRÉDITOS -->
    <div class="text-center mt-4 pt-4 border-top border-secondary">
      <small class="text-muted">
        <i class="fas fa-laptop-code me-1"></i>
        Sistema de Asignación de Experimentos - Laboratorio 3 Farmacia Química
      </small>
    </div>
  </div>

  <script>
    // CONFIGURACIÓN
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx9vsQgUypBfUThBnf-Jk7fHnBWui7FRZNDNhO5W6qY8LSMgs6g64kF_53gaGF18T3ofQ/exec';
    const MAX_POR_EQUIPO = 5;
    const TOTAL_EQUIPOS = 12;

    // ========== FUNCIONES PARA GOOGLE SHEETS ==========
    
    // Obtener Registros desde Google Sheets
    async function obtenerRegistrosDesdeGoogleSheets() {
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=listar`);
        const data = await response.json();
        
        if (data.status === 'ok') {
          return data.data;
        }
        return [];
      } catch (error) {
        console.error('Error:', error);
        mostrarError('Error al cargar los registros');
        return [];
      }
    }
    
    // Obtener conteo por equipo desde Google Sheets
    async function obtenerConteoEquipos() {
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=contar`);
        const data = await response.json();
        
        if (data.status === 'ok') {
          return data.conteo;
        }
        return {};
      } catch (error) {
        console.error('Error:', error);
        return {};
      }
    }
    
    // Obtener equipos fijados desde Google Sheets
    async function obtenerEquiposFijados() {
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=obtenerEquiposFijados`);
        const data = await response.json();
        
        if (data.status === 'ok') {
          return data.data;
        }
        return {};
      } catch (error) {
        console.error('Error al obtener equipos fijados:', error);
        return {};
      }
    }
    
    // ========== FUNCIONES PRINCIPALES ==========
    
    // Cargar y mostrar equipos completos
    async function cargarEquiposCompletos() {
      const contenedor = document.getElementById('contenedor-equipos');
      const mensajeCarga = document.getElementById('mensaje-carga');
      const mensajeSinEquipos = document.getElementById('mensaje-sin-equipos');
      const contadorCompletos = document.getElementById('contador-completos');
      const contadorExperimentos = document.getElementById('contador-experimentos');
      
      // Mostrar carga
      mensajeCarga.classList.remove('d-none');
      mensajeSinEquipos.classList.add('d-none');
      
      try {
        // Obtener datos desde Google Sheets
        const conteo = await obtenerConteoEquipos();
        const equiposFijados = await obtenerEquiposFijados();
        const registros = await obtenerRegistrosDesdeGoogleSheets();
        
        // Contar equipos completos y con experimentos asignados
        let equiposCompletosCount = 0;
        let experimentosAsignadosCount = 0;
        
        // Crear array de equipos completos
        const equiposCompletos = [];
        
        for (let equipo = 1; equipo <= TOTAL_EQUIPOS; equipo++) {
          const personas = conteo[equipo] || 0;
          const estaCompleto = personas === MAX_POR_EQUIPO;
          
          if (estaCompleto) {
            equiposCompletosCount++;
            
            // Verificar si tiene experimento asignado
            const fijado = equiposFijados[equipo] ? true : false;
            const experimento = fijado ? equiposFijados[equipo].experimento : "Pendiente de asignación";
            const codigo = fijado ? equiposFijados[equipo].codigo : `EXP-${equipo.toString().padStart(2, '0')}`;
            
            if (fijado) {
              experimentosAsignadosCount++;
            }
            
            // Obtener miembros del equipo
            const miembros = registros.filter(reg => reg.equipo == equipo);
            
            equiposCompletos.push({
              numero: equipo,
              personas: personas,
              fijado: fijado,
              experimento: experimento,
              codigo: codigo,
              miembros: miembros,
              fechaFijado: fijado ? equiposFijados[equipo].fechaFijado : null
            });
          }
        }
        
        // Actualizar contadores
        contadorCompletos.textContent = equiposCompletosCount;
        contadorExperimentos.textContent = experimentosAsignadosCount;
        
        // Mostrar mensaje si no hay equipos completos
        if (equiposCompletosCount === 0) {
          mensajeCarga.classList.add('d-none');
          mensajeSinEquipos.classList.remove('d-none');
          contenedor.innerHTML = '';
          return;
        }
        
        // Ordenar equipos por número
        equiposCompletos.sort((a, b) => a.numero - b.numero);
        
        // Crear HTML para cada equipo completo
        let html = '';
        
        equiposCompletos.forEach(equipo => {
          const fechaFormateada = equipo.fechaFijado ? 
            new Date(equipo.fechaFijado).toLocaleString('es-ES', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }) : 'Pendiente';
          
          html += `
            <div class="experiment-card ${equipo.fijado ? 'fijado' : 'pendiente'}">
              <div class="row align-items-center">
                <div class="col-md-3">
                  <div class="text-center mb-3 mb-md-0">
                    <span class="team-badge d-inline-block mb-2">Equipo ${equipo.numero}</span>
                    <div>
                      <span class="badge ${equipo.fijado ? 'bg-success' : 'bg-warning'}">
                        ${equipo.fijado ? 'ASIGNADO' : 'PENDIENTE'}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <h5 class="mb-2">${equipo.experimento}</h5>
                  <p class="mb-1">
                    <small class="text-muted">
                      <i class="fas fa-hashtag me-1"></i>Código: ${equipo.codigo}
                    </small>
                  </p>
                  <p class="mb-1">
                    <small class="text-muted">
                      <i class="fas fa-calendar-alt me-1"></i>Estado: ${equipo.fijado ? 'Fijado el ' + fechaFormateada : 'En espera de asignación'}
                    </small>
                  </p>
                  <p class="mb-0">
                    <small class="text-muted">
                      <i class="fas fa-users me-1"></i>${equipo.personas}/${MAX_POR_EQUIPO} integrantes
                    </small>
                  </p>
                </div>
                
                <div class="col-md-3">
                  <div class="text-center text-md-end">
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="mostrarMiembrosEquipo(${equipo.numero})"
                            data-bs-toggle="tooltip" 
                            title="Ver integrantes del equipo">
                      <i class="fas fa-user-friends me-1"></i>Ver Integrantes
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Sección de miembros (oculta por defecto) -->
              <div class="mt-3 d-none" id="miembros-equipo-${equipo.numero}">
                <div class="card bg-light">
                  <div class="card-body">
                    <h6 class="card-title text-dark mb-3">
                      <i class="fas fa-user-friends me-2"></i>Integrantes del Equipo ${equipo.numero}
                    </h6>
                    <div class="row">
                      ${equipo.miembros.map((miembro, index) => `
                        <div class="col-md-6 col-lg-4 mb-2">
                          <div class="d-flex align-items-center p-2 bg-white rounded">
                            <div class="me-3">
                              <span class="badge bg-secondary">${index + 1}</span>
                            </div>
                            <div>
                              <div class="text-dark"><strong>${miembro.nombre}</strong></div>
                              <small class="text-muted">${miembro.fecha}</small>
                            </div>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        
        // Actualizar contenedor
        contenedor.innerHTML = html;
        mensajeCarga.classList.add('d-none');
        
        // Inicializar tooltips de Bootstrap
        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(tooltip => {
          new bootstrap.Tooltip(tooltip);
        });
        
      } catch (error) {
        console.error('Error al cargar equipos:', error);
        mostrarError('Error al cargar la información de los equipos');
        mensajeCarga.classList.add('d-none');
      }
    }
    
    // Mostrar/ocultar miembros de un equipo
    function mostrarMiembrosEquipo(numeroEquipo) {
      const seccion = document.getElementById(`miembros-equipo-${numeroEquipo}`);
      const boton = event.currentTarget;
      
      if (seccion.classList.contains('d-none')) {
        seccion.classList.remove('d-none');
        boton.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Ocultar Integrantes';
        boton.classList.remove('btn-outline-primary');
        boton.classList.add('btn-primary');
      } else {
        seccion.classList.add('d-none');
        boton.innerHTML = '<i class="fas fa-user-friends me-1"></i>Ver Integrantes';
        boton.classList.remove('btn-primary');
        boton.classList.add('btn-outline-primary');
      }
    }
    
    // Actualizar datos manualmente
    async function actualizarDatos() {
      const boton = event.currentTarget;
      const iconoOriginal = boton.innerHTML;
      
      // Mostrar loading en el botón
      boton.disabled = true;
      boton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Actualizando...';
      
      // Actualizar datos
      await cargarEquiposCompletos();
      
      // Restaurar botón
      setTimeout(() => {
        boton.disabled = false;
        boton.innerHTML = iconoOriginal;
        
        // Mostrar mensaje de éxito
        mostrarMensaje('Datos actualizados correctamente', 'success');
      }, 1000);
    }
    
    // Mostrar mensaje de error
    function mostrarError(mensaje) {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3';
      alertDiv.style.zIndex = '9999';
      alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${mensaje}
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      // Auto-eliminar después de 5 segundos
      setTimeout(() => {
        if (alertDiv.parentNode) {
          const bsAlert = new bootstrap.Alert(alertDiv);
          bsAlert.close();
        }
      }, 5000);
    }
    
    // Mostrar mensaje de éxito
    function mostrarMensaje(mensaje, tipo = 'success') {
      const tipos = {
        success: 'alert-success',
        error: 'alert-danger',
        warning: 'alert-warning',
        info: 'alert-info'
      };
      
      const iconos = {
        success: 'fa-check-circle',
        error: 'fa-times-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };
      
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert ${tipos[tipo]} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
      alertDiv.style.zIndex = '9999';
      alertDiv.innerHTML = `
        <i class="fas ${iconos[tipo]} me-2"></i>
        ${mensaje}
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      // Auto-eliminar después de 5 segundos
      setTimeout(() => {
        if (alertDiv.parentNode) {
          const bsAlert = new bootstrap.Alert(alertDiv);
          bsAlert.close();
        }
      }, 3000);
    }
    
    // Inicializar la página
    document.addEventListener('DOMContentLoaded', async function() {
      // Cargar datos iniciales
      await cargarEquiposCompletos();
      
      // Actualizar automáticamente cada 3 segundos
      setInterval(async () => {
        await cargarEquiposCompletos();
      }, 3000);
    });
  </script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
